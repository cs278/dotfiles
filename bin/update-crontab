#!/bin/sh

set -e
set -u
#set -x

header="# Automatically generated by update-crontab!"
config="${XDG_CONFIG_HOME:-$HOME/.config}/crontab"

if [ ! -z "`crontab -l 2>/dev/null`" ] && ! crontab -l 2>/dev/null | grep -q "$header";
then
	echo "update-crontab: Current crontab has been modified; aborting." >&2
	exit 1
fi

path=

if [ -z "$path" ] && [ -f "$HOME/.profile" ];
then
	path=$(sh -c '. $HOME/.profile; echo $PATH' || true)
fi

if [ -z "$path" ] && [ -f "/etc/environment" ];
then
	path=$(sh -c '. /etc/environment; echo "$HOME/bin:$PATH"' || true)
fi

(
	echo "$header"
	echo

	if [ ! -z "$path" ];
	then
		echo "# Generated path"
		printf 'PATH="%s"\n' "$path"
		echo
	fi

	if [ ! -z "$EMAIL" ];
	then
		echo '# Using $EMAIL for email'
		printf 'MAILTO="%s"\n' "$EMAIL"
		echo
	fi

	for file in $config/jobs/??-*;
	do
		printf '# Job `%s`\n' "$(basename $file)"
		cat "$file"
		printf '# End Job `%s`\n' "$(basename $file)"
		echo
	done
) | crontab -
